CREATE OR REPLACE PROCEDURE AUD_C_FST900_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST900_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'FST900',CONCAT( CONCAT( CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ),CONCAT( '|PGMNOM=', RTRIM(COALESCE(AUD_old_PGMNOM,AUD_new_PGMNOM)) ) ),'|' ),AUD_FST900_UBT,AUD_FST900_UBU,AUD_FST900_UBM,AUD_FST900_UBP,AUD_FST900_UBR,AUD_FST900_UAs,AUD_FST900_UBC,AUD_FST900_UBA,AUD_FST900_UBS, '', 'BANTOTAL', '', '', '',AUD_FST900_UT FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGMCALL',AUD_old_PGMCALL,AUD_new_PGMCALL FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGMCALL'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGMCD1',AUD_old_PGMCD1,AUD_new_PGMCD1 FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGMCD1'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGMCD2',AUD_old_PGMCD2,AUD_new_PGMCD2 FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGMCD2'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGMDES',AUD_old_PGMDES,AUD_new_PGMDES FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGMDES'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST900_UOn,AUD_FST900_GuidKey,'PGMNOM',AUD_old_PGMNOM,AUD_new_PGMNOM FROM BANTPROD.AUD_FST900_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey AND AUDMstFld = 'PGMNOM'); DELETE FROM AUD_FST900_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST900_UOn AND AUDMstId = AUD_FST900_GuidKey);  COMMIT ;END IF;END;
/

