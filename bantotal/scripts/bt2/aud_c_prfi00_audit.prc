CREATE OR REPLACE PROCEDURE AUD_C_PRFI00_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_PRFI00_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFI00',CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( '|INSTCOD=', RTRIM(COALESCE(AUD_old_INSTCOD,AUD_new_INSTCOD)) ),CONCAT( '|MODULO=', RTRIM(COALESCE(AUD_old_MODULO,AUD_new_MODULO)) ) ),CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ) ),CONCAT( '|PRFGCOD=', RTRIM(COALESCE(AUD_old_PRFGCOD,AUD_new_PRFGCOD)) ) ),'|' ),AUD_PRFI00_UBT,AUD_PRFI00_UBU,AUD_PRFI00_UBM,AUD_PRFI00_UBP,AUD_PRFI00_UBR,AUD_PRFI00_UAs,AUD_PRFI00_UBC,AUD_PRFI00_UBA,AUD_PRFI00_UBS, '', 'BANTOTAL', '', '', '',AUD_PRFI00_UT FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'INSTCOD',AUD_old_INSTCOD,AUD_new_INSTCOD FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'INSTCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'MODULO',AUD_old_MODULO,AUD_new_MODULO FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'MODULO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFGCOD',AUD_old_PRFGCOD,AUD_new_PRFGCOD FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTAUT',AUD_old_PRFINSTAUT,AUD_new_PRFINSTAUT FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTAUT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTFEA',TO_CHAR(AUD_old_PRFINSTFEA,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFINSTFEA,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTFEA'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTFEC',TO_CHAR(AUD_old_PRFINSTFEC,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFINSTFEC,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTFEC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTIMP',AUD_old_PRFINSTIMP,AUD_new_PRFINSTIMP FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTIMP'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTQRY',AUD_old_PRFINSTQRY,AUD_new_PRFINSTQRY FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTQRY'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTUPD',AUD_old_PRFINSTUPD,AUD_new_PRFINSTUPD FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UO
n AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTUPD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFI00_UOn,AUD_PRFI00_GuidKey,'PRFINSTUSU',AUD_old_PRFINSTUSU,AUD_new_PRFINSTUSU FROM BANTPROD.AUD_PRFI00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey AND AUDMstFld = 'PRFINSTUSU'); DELETE FROM AUD_PRFI00_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFI00_UOn AND AUDMstId = AUD_PRFI00_GuidKey);  COMMIT ;END IF;END;
/

