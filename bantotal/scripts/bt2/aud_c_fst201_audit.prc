CREATE OR REPLACE PROCEDURE AUD_C_FST201_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST201_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'FST201',CONCAT( CONCAT( CONCAT( CONCAT( '|MODULO=', RTRIM(COALESCE(AUD_old_MODULO,AUD_new_MODULO)) ),CONCAT( '|OPMCOD=', RTRIM(COALESCE(AUD_old_OPMCOD,AUD_new_OPMCOD)) ) ),CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ) ),'|' ),AUD_FST201_UBT,AUD_FST201_UBU,AUD_FST201_UBM,AUD_FST201_UBP,AUD_FST201_UBR,AUD_FST201_UAs,AUD_FST201_UBC,AUD_FST201_UBA,AUD_FST201_UBS, '', 'BANTOTAL', '', '', '',AUD_FST201_UT FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'MODULO',AUD_old_MODULO,AUD_new_MODULO FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey AND AUDMstFld = 'MODULO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'OPMCOD',AUD_old_OPMCOD,AUD_new_OPMCOD FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey AND AUDMstFld = 'OPMCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'OPMTXT',AUD_old_OPMTXT,AUD_new_OPMTXT FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey AND AUDMstFld = 'OPMTXT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'OPMVAL',AUD_old_OPMVAL,AUD_new_OPMVAL FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey AND AUDMstFld = 'OPMVAL'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST201_UOn,AUD_FST201_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_FST201_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey AND AUDMstFld = 'PGCOD'); DELETE FROM AUD_FST201_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST201_UOn AND AUDMstId = AUD_FST201_GuidKey);  COMMIT ;END IF;END;
/

