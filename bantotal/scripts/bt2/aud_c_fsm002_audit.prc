CREATE OR REPLACE PROCEDURE AUD_C_FSM002_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FSM002_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FSM002_UOn,AUD_FSM002_GuidKey,'FSM002',CONCAT( CONCAT( CONCAT( '|PRGCMPPOS=', RTRIM(COALESCE(AUD_old_PRGCMPPOS,AUD_new_PRGCMPPOS)) ),CONCAT( '|PRGNOM=', RTRIM(COALESCE(AUD_old_PRGNOM,AUD_new_PRGNOM)) ) ),'|' ),AUD_FSM002_UBT,AUD_FSM002_UBU,AUD_FSM002_UBM,AUD_FSM002_UBP,AUD_FSM002_UBR,AUD_FSM002_UAs,AUD_FSM002_UBC,AUD_FSM002_UBA,AUD_FSM002_UBS, '', 'BANTOTAL', '', '', '',AUD_FSM002_UT FROM BANTPROD.AUD_FSM002_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSM002_UOn AND AUDMstId = AUD_FSM002_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSM002_UOn,AUD_FSM002_GuidKey,'PRGCMPNOM',AUD_old_PRGCMPNOM,AUD_new_PRGCMPNOM FROM BANTPROD.AUD_FSM002_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSM002_UOn AND AUDMstId = AUD_FSM002_GuidKey AND AUDMstFld = 'PRGCMPNOM'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSM002_UOn,AUD_FSM002_GuidKey,'PRGCMPPOS',AUD_old_PRGCMPPOS,AUD_new_PRGCMPPOS FROM BANTPROD.AUD_FSM002_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSM002_UOn AND AUDMstId = AUD_FSM002_GuidKey AND AUDMstFld = 'PRGCMPPOS'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSM002_UOn,AUD_FSM002_GuidKey,'PRGNOM',AUD_old_PRGNOM,AUD_new_PRGNOM FROM BANTPROD.AUD_FSM002_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSM002_UOn AND AUDMstId = AUD_FSM002_GuidKey AND AUDMstFld = 'PRGNOM'); DELETE FROM AUD_FSM002_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSM002_UOn AND AUDMstId = AUD_FSM002_GuidKey);  COMMIT ;END IF;END;
/

