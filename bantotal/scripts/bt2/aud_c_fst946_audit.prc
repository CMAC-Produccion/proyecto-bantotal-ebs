CREATE OR REPLACE PROCEDURE AUD_C_FST946_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST946_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST946_UOn,AUD_FST946_GuidKey,'FST946',CONCAT( CONCAT( CONCAT( '|SESSUSR=', RTRIM(COALESCE(AUD_old_SESSUSR,AUD_new_SESSUSR)) ),CONCAT( '|SESSWRK=', RTRIM(COALESCE(AUD_old_SESSWRK,AUD_new_SESSWRK)) ) ),'|' ),AUD_FST946_UBT,AUD_FST946_UBU,AUD_FST946_UBM,AUD_FST946_UBP,AUD_FST946_UBR,AUD_FST946_UAs,AUD_FST946_UBC,AUD_FST946_UBA,AUD_FST946_UBS, '', 'BANTOTAL', '', '', '',AUD_FST946_UT FROM BANTPROD.AUD_FST946_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST946_UOn,AUD_FST946_GuidKey,'SESSFCH',TO_CHAR(AUD_old_SESSFCH,'YYYY-MM-DD'),TO_CHAR(AUD_new_SESSFCH,'YYYY-MM-DD') FROM BANTPROD.AUD_FST946_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey AND AUDMstFld = 'SESSFCH'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST946_UOn,AUD_FST946_GuidKey,'SESSHORA',AUD_old_SESSHORA,AUD_new_SESSHORA FROM BANTPROD.AUD_FST946_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey AND AUDMstFld = 'SESSHORA'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST946_UOn,AUD_FST946_GuidKey,'SESSUSR',AUD_old_SESSUSR,AUD_new_SESSUSR FROM BANTPROD.AUD_FST946_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey AND AUDMstFld = 'SESSUSR'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST946_UOn,AUD_FST946_GuidKey,'SESSWRK',AUD_old_SESSWRK,AUD_new_SESSWRK FROM BANTPROD.AUD_FST946_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey AND AUDMstFld = 'SESSWRK'); DELETE FROM AUD_FST946_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST946_UOn AND AUDMstId = AUD_FST946_GuidKey);  COMMIT ;END IF;END;
/

