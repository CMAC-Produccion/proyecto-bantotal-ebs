CREATE OR REPLACE PROCEDURE AUD_C_FST746_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST746_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'FST746',CONCAT( CONCAT( '|UBUSER=', RTRIM(COALESCE(AUD_old_UBUSER,AUD_new_UBUSER)) ),'|' ),AUD_FST746_UBT,AUD_FST746_UBU,AUD_FST746_UBM,AUD_FST746_UBP,AUD_FST746_UBR,AUD_FST746_UAs,AUD_FST746_UBC,AUD_FST746_UBA,AUD_FST746_UBS, '', 'BANTOTAL', '', '', '',AUD_FST746_UT FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'PGCODAC',AUD_old_PGCODAC,AUD_new_PGCODAC FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'PGCODAC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'PGNOMAC',AUD_old_PGNOMAC,AUD_new_PGNOMAC FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'PGNOMAC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'UBFECH',TO_CHAR(AUD_old_UBFECH,'YYYY-MM-DD'),TO_CHAR(AUD_new_UBFECH,'YYYY-MM-DD') FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'UBFECH'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'UBHORA',AUD_old_UBHORA,AUD_new_UBHORA FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'UBHORA'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'UBNOM',AUD_old_UBNOM,AUD_new_UBNOM FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'UBNOM'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST746_UOn,AUD_FST746_GuidKey,'UBUSER',AUD_old_UBUSER,AUD_new_UBUSER FROM BANTPROD.AUD_FST746_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey AND AUDMstFld = 'UBUSER'); DELETE FROM AUD_FST746_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST746_UOn AND AUDMstId = AUD_FST746_GuidKey);  COMMIT ;END IF;END;
/

