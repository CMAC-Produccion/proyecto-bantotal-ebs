CREATE OR REPLACE PROCEDURE AUD_C_FST200_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST200_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST200_UOn,AUD_FST200_GuidKey,'FST200',CONCAT( CONCAT( CONCAT( '|OPGCOD=', RTRIM(COALESCE(AUD_old_OPGCOD,AUD_new_OPGCOD)) ),CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ) ),'|' ),AUD_FST200_UBT,AUD_FST200_UBU,AUD_FST200_UBM,AUD_FST200_UBP,AUD_FST200_UBR,AUD_FST200_UAs,AUD_FST200_UBC,AUD_FST200_UBA,AUD_FST200_UBS, '', 'BANTOTAL', '', '', '',AUD_FST200_UT FROM BANTPROD.AUD_FST200_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST200_UOn,AUD_FST200_GuidKey,'OPGCOD',AUD_old_OPGCOD,AUD_new_OPGCOD FROM BANTPROD.AUD_FST200_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey AND AUDMstFld = 'OPGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST200_UOn,AUD_FST200_GuidKey,'OPGTXT',AUD_old_OPGTXT,AUD_new_OPGTXT FROM BANTPROD.AUD_FST200_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey AND AUDMstFld = 'OPGTXT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST200_UOn,AUD_FST200_GuidKey,'OPGVAL',AUD_old_OPGVAL,AUD_new_OPGVAL FROM BANTPROD.AUD_FST200_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey AND AUDMstFld = 'OPGVAL'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST200_UOn,AUD_FST200_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_FST200_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey AND AUDMstFld = 'PGCOD'); DELETE FROM AUD_FST200_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST200_UOn AND AUDMstId = AUD_FST200_GuidKey);  COMMIT ;END IF;END;
/

