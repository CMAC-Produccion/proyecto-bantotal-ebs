CREATE OR REPLACE PROCEDURE AUD_C_SNG403_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_SNG403_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG403',CONCAT( CONCAT( CONCAT( CONCAT( '|SNG400COD=', RTRIM(COALESCE(AUD_old_SNG400COD,AUD_new_SNG400COD)) ),CONCAT( '|SNG400EVTO=', RTRIM(COALESCE(AUD_old_SNG400EVTO,AUD_new_SNG400EVTO)) ) ),CONCAT( '|SNG403PRG=', RTRIM(COALESCE(AUD_old_SNG403PRG,AUD_new_SNG403PRG)) ) ),'|' ),AUD_SNG403_UBT,AUD_SNG403_UBU,AUD_SNG403_UBM,AUD_SNG403_UBP,AUD_SNG403_UBR,AUD_SNG403_UAs,AUD_SNG403_UBC,AUD_SNG403_UBA,AUD_SNG403_UBS, '', 'BANTOTAL', '', '', '',AUD_SNG403_UT FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG400COD',AUD_old_SNG400COD,AUD_new_SNG400COD FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG400COD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG400EVTO',AUD_old_SNG400EVTO,AUD_new_SNG400EVTO FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG400EVTO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG403FVD',TO_CHAR(AUD_old_SNG403FVD,'YYYY-MM-DD'),TO_CHAR(AUD_new_SNG403FVD,'YYYY-MM-DD') FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG403FVD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG403FVH',TO_CHAR(AUD_old_SNG403FVH,'YYYY-MM-DD'),TO_CHAR(AUD_new_SNG403FVH,'YYYY-MM-DD') FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG403FVH'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG403NOT',AUD_old_SNG403NOT,AUD_new_SNG403NOT FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG403NOT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNG403_UOn,AUD_SNG403_GuidKey,'SNG403PRG',AUD_old_SNG403PRG,AUD_new_SNG403PRG FROM BANTPROD.AUD_SNG403_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey AND AUDMstFld = 'SNG403PRG'); DELETE FROM AUD_SNG403_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_SNG403_UOn AND AUDMstId = AUD_SNG403_GuidKey);  COMMIT ;END IF;END;
/

