CREATE OR REPLACE PROCEDURE AUD_C_FSI006_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FSI006_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'FSI006',CONCAT( CONCAT( CONCAT( CONCAT( '|CICPO=', RTRIM(COALESCE(AUD_old_CICPO,AUD_new_CICPO)) ),CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ) ),CONCAT( '|RUBRO=', RTRIM(COALESCE(AUD_old_RUBRO,AUD_new_RUBRO)) ) ),'|' ),AUD_FSI006_UBT,AUD_FSI006_UBU,AUD_FSI006_UBM,AUD_FSI006_UBP,AUD_FSI006_UBR,AUD_FSI006_UAs,AUD_FSI006_UBC,AUD_FSI006_UBA,AUD_FSI006_UBS, '', 'BANTOTAL', '', '', '',AUD_FSI006_UT FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'CICPO',AUD_old_CICPO,AUD_new_CICPO FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'CICPO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'CIPZOD',AUD_old_CIPZOD,AUD_new_CIPZOD FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'CIPZOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'CIPZOH',AUD_old_CIPZOH,AUD_new_CIPZOH FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'CIPZOH'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'CIPZOT',AUD_old_CIPZOT,AUD_new_CIPZOT FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'CIPZOT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI006_UOn,AUD_FSI006_GuidKey,'RUBRO',AUD_old_RUBRO,AUD_new_RUBRO FROM BANTPROD.AUD_FSI006_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey AND AUDMstFld = 'RUBRO'); DELETE FROM AUD_FSI006_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSI006_UOn AND AUDMstId = AUD_FSI006_GuidKey);  COMMIT ;END IF;END;
/

