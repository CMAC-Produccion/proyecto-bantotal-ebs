CREATE OR REPLACE PROCEDURE AUD_C_PRFP00_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_PRFP00_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRFP00',CONCAT( CONCAT( CONCAT( CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ),CONCAT( '|PRFGCOD=', RTRIM(COALESCE(AUD_old_PRFGCOD,AUD_new_PRFGCOD)) ) ),CONCAT( '|PRGNOM=', RTRIM(COALESCE(AUD_old_PRGNOM,AUD_new_PRGNOM)) ) ),'|' ),AUD_PRFP00_UBT,AUD_PRFP00_UBU,AUD_PRFP00_UBM,AUD_PRFP00_UBP,AUD_PRFP00_UBR,AUD_PRFP00_UAs,AUD_PRFP00_UBC,AUD_PRFP00_UBA,AUD_PRFP00_UBS, '', 'BANTOTAL', '', '', '',AUD_PRFP00_UT FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRFGCOD',AUD_old_PRFGCOD,AUD_new_PRFGCOD FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PRFGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRFPFECALT',TO_CHAR(AUD_old_PRFPFECALT,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFPFECALT,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PRFPFECALT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRFPFECVTO',TO_CHAR(AUD_old_PRFPFECVTO,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFPFECVTO,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PRFPFECVTO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRFPUSER',AUD_old_PRFPUSER,AUD_new_PRFPUSER FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PRFPUSER'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFP00_UOn,AUD_PRFP00_GuidKey,'PRGNOM',AUD_old_PRGNOM,AUD_new_PRGNOM FROM BANTPROD.AUD_PRFP00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey AND AUDMstFld = 'PRGNOM'); DELETE FROM AUD_PRFP00_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFP00_UOn AND AUDMstId = AUD_PRFP00_GuidKey);  COMMIT ;END IF;END;
/

