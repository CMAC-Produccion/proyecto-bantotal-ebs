CREATE OR REPLACE PROCEDURE AUD_C_TI0001_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_TI0001_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TI0001',CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( '|TIIMPUCOD=', RTRIM(COALESCE(AUD_old_TIIMPUCOD,AUD_new_TIIMPUCOD)) ),CONCAT( '|TIRIPCORR=', RTRIM(COALESCE(AUD_old_TIRIPCORR,AUD_new_TIRIPCORR)) ) ),CONCAT( '|TIRIPNDOC=', RTRIM(COALESCE(AUD_old_TIRIPNDOC,AUD_new_TIRIPNDOC)) ) ),CONCAT( '|TIRIPPAIS=', RTRIM(COALESCE(AUD_old_TIRIPPAIS,AUD_new_TIRIPPAIS)) ) ),CONCAT( '|TIRIPTDOC=', RTRIM(COALESCE(AUD_old_TIRIPTDOC,AUD_new_TIRIPTDOC)) ) ),'|' ),AUD_TI0001_UBT,AUD_TI0001_UBU,AUD_TI0001_UBM,AUD_TI0001_UBP,AUD_TI0001_UBR,AUD_TI0001_UAs,AUD_TI0001_UBC,AUD_TI0001_UBA,AUD_TI0001_UBS, '', 'BANTOTAL', '', '', '',AUD_TI0001_UT FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TICD_ANT_I',AUD_old_TICD_ANT_I,AUD_new_TICD_ANT_I FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TICD_ANT_I'); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TIIMPUCOD',AUD_old_TIIMPUCOD,AUD_new_TIIMPUCOD FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TIIMPUCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TIRIPCORR',AUD_old_TIRIPCORR,AUD_new_TIRIPCORR FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TIRIPCORR'); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TIRIPNDOC',AUD_old_TIRIPNDOC,AUD_new_TIRIPNDOC FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TIRIPNDOC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TIRIPPAIS',AUD_old_TIRIPPAIS,AUD_new_TIRIPPAIS FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TIRIPPAIS'); INSERT INTO BANTPROD.AUD005 SELECT AUD_TI0001_UOn,AUD_TI0001_GuidKey,'TIRIPTDOC',AUD_old_TIRIPTDOC,AUD_new_TIRIPTDOC FROM BANTPROD.AUD_TI0001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey AND AUDMstFld = 'TIRIPTDOC'); DELETE FROM AUD_TI0001_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_TI0001_UOn AND AUDMstId = AUD_TI0001_GuidKey);  COMMIT ;END IF;END;
/

