CREATE OR REPLACE PROCEDURE AUD_C_PRFG00_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_PRFG00_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PRFG00',CONCAT( CONCAT( CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ),CONCAT( '|PRFGCOD=', RTRIM(COALESCE(AUD_old_PRFGCOD,AUD_new_PRFGCOD)) ) ),'|' ),AUD_PRFG00_UBT,AUD_PRFG00_UBU,AUD_PRFG00_UBM,AUD_PRFG00_UBP,AUD_PRFG00_UBR,AUD_PRFG00_UAs,AUD_PRFG00_UBC,AUD_PRFG00_UBA,AUD_PRFG00_UBS, '', 'BANTOTAL', '', '', '',AUD_PRFG00_UT FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PRFGCOD',AUD_old_PRFGCOD,AUD_new_PRFGCOD FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey AND AUDMstFld = 'PRFGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PRFGFECALT',TO_CHAR(AUD_old_PRFGFECALT,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFGFECALT,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey AND AUDMstFld = 'PRFGFECALT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PRFGNOM',AUD_old_PRFGNOM,AUD_new_PRFGNOM FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey AND AUDMstFld = 'PRFGNOM'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFG00_UOn,AUD_PRFG00_GuidKey,'PRFGUSER',AUD_old_PRFGUSER,AUD_new_PRFGUSER FROM BANTPROD.AUD_PRFG00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey AND AUDMstFld = 'PRFGUSER'); DELETE FROM AUD_PRFG00_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFG00_UOn AND AUDMstId = AUD_PRFG00_GuidKey);  COMMIT ;END IF;END;
/

