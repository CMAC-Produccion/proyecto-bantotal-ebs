CREATE OR REPLACE PROCEDURE AUD_C_FSI001_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FSI001_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'FSI001',CONCAT( CONCAT( CONCAT( '|CICPO=', RTRIM(COALESCE(AUD_old_CICPO,AUD_new_CICPO)) ),CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ) ),'|' ),AUD_FSI001_UBT,AUD_FSI001_UBU,AUD_FSI001_UBM,AUD_FSI001_UBP,AUD_FSI001_UBR,AUD_FSI001_UAs,AUD_FSI001_UBC,AUD_FSI001_UBA,AUD_FSI001_UBS, '', 'BANTOTAL', '', '', '',AUD_FSI001_UT FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'CICPO',AUD_old_CICPO,AUD_new_CICPO FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey AND AUDMstFld = 'CICPO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'CINOM',AUD_old_CINOM,AUD_new_CINOM FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey AND AUDMstFld = 'CINOM'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'CITPOC',AUD_old_CITPOC,AUD_new_CITPOC FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey AND AUDMstFld = 'CITPOC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'CITPOI',AUD_old_CITPOI,AUD_new_CITPOI FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey AND AUDMstFld = 'CITPOI'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSI001_UOn,AUD_FSI001_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_FSI001_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey AND AUDMstFld = 'PGCOD'); DELETE FROM AUD_FSI001_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSI001_UOn AND AUDMstId = AUD_FSI001_GuidKey);  COMMIT ;END IF;END;
/

