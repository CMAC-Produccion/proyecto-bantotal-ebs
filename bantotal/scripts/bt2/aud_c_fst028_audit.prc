CREATE OR REPLACE PROCEDURE AUD_C_FST028_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FST028_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FST028_UOn,AUD_FST028_GuidKey,'FST028',CONCAT( CONCAT( CONCAT( '|CALCOD=', RTRIM(COALESCE(AUD_old_CALCOD,AUD_new_CALCOD)) ),CONCAT( '|FFECHA=', RTRIM(COALESCE(AUD_old_FFECHA,AUD_new_FFECHA)) ) ),'|' ),AUD_FST028_UBT,AUD_FST028_UBU,AUD_FST028_UBM,AUD_FST028_UBP,AUD_FST028_UBR,AUD_FST028_UAs,AUD_FST028_UBC,AUD_FST028_UBA,AUD_FST028_UBS, '', 'BANTOTAL', '', '', '',AUD_FST028_UT FROM BANTPROD.AUD_FST028_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST028_UOn AND AUDMstId = AUD_FST028_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST028_UOn,AUD_FST028_GuidKey,'CALCOD',AUD_old_CALCOD,AUD_new_CALCOD FROM BANTPROD.AUD_FST028_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST028_UOn AND AUDMstId = AUD_FST028_GuidKey AND AUDMstFld = 'CALCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST028_UOn,AUD_FST028_GuidKey,'FFECHA',TO_CHAR(AUD_old_FFECHA,'YYYY-MM-DD'),TO_CHAR(AUD_new_FFECHA,'YYYY-MM-DD') FROM BANTPROD.AUD_FST028_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST028_UOn AND AUDMstId = AUD_FST028_GuidKey AND AUDMstFld = 'FFECHA'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FST028_UOn,AUD_FST028_GuidKey,'FHABIL',AUD_old_FHABIL,AUD_new_FHABIL FROM BANTPROD.AUD_FST028_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FST028_UOn AND AUDMstId = AUD_FST028_GuidKey AND AUDMstFld = 'FHABIL'); DELETE FROM AUD_FST028_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FST028_UOn AND AUDMstId = AUD_FST028_GuidKey);  COMMIT ;END IF;END;
/

