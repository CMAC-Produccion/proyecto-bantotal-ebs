CREATE OR REPLACE PROCEDURE AUD_C_SNGU02_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_SNGU02_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02',CONCAT( CONCAT( CONCAT( '|SNGU02PGC=', RTRIM(COALESCE(AUD_old_SNGU02PGC,AUD_new_SNGU02PGC)) ),CONCAT( '|SNGU02USR=', RTRIM(COALESCE(AUD_old_SNGU02USR,AUD_new_SNGU02USR)) ) ),'|' ),AUD_SNGU02_UBT,AUD_SNGU02_UBU,AUD_SNGU02_UBM,AUD_SNGU02_UBP,AUD_SNGU02_UBR,AUD_SNGU02_UAs,AUD_SNGU02_UBC,AUD_SNGU02_UBA,AUD_SNGU02_UBS, '', 'BANTOTAL', '', '', '',AUD_SNGU02_UT FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU01TIP',AUD_old_SNGU01TIP,AUD_new_SNGU01TIP FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU01TIP'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02COD',AUD_old_SNGU02COD,AUD_new_SNGU02COD FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU02COD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02FIN',TO_CHAR(AUD_old_SNGU02FIN,'YYYY-MM-DD'),TO_CHAR(AUD_new_SNGU02FIN,'YYYY-MM-DD') FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU02FIN'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02INH',AUD_old_SNGU02INH,AUD_new_SNGU02INH FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU02INH'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02PGC',AUD_old_SNGU02PGC,AUD_new_SNGU02PGC FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU02PGC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_SNGU02_UOn,AUD_SNGU02_GuidKey,'SNGU02USR',AUD_old_SNGU02USR,AUD_new_SNGU02USR FROM BANTPROD.AUD_SNGU02_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey AND AUDMstFld = 'SNGU02USR'); DELETE FROM AUD_SNGU02_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_SNGU02_UOn AND AUDMstId = AUD_SNGU02_GuidKey);  COMMIT ;END IF;END;
/

