CREATE OR REPLACE PROCEDURE AUD_C_PRFU00_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_PRFU00_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFU00',CONCAT( CONCAT( CONCAT( CONCAT( '|PGCOD=', RTRIM(COALESCE(AUD_old_PGCOD,AUD_new_PGCOD)) ),CONCAT( '|PRFGCOD=', RTRIM(COALESCE(AUD_old_PRFGCOD,AUD_new_PRFGCOD)) ) ),CONCAT( '|UBUSER=', RTRIM(COALESCE(AUD_old_UBUSER,AUD_new_UBUSER)) ) ),'|' ),AUD_PRFU00_UBT,AUD_PRFU00_UBU,AUD_PRFU00_UBM,AUD_PRFU00_UBP,AUD_PRFU00_UBR,AUD_PRFU00_UAs,AUD_PRFU00_UBC,AUD_PRFU00_UBA,AUD_PRFU00_UBS, '', 'BANTOTAL', '', '', '',AUD_PRFU00_UT FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PGCOD',AUD_old_PGCOD,AUD_new_PGCOD FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFGCOD',AUD_old_PRFGCOD,AUD_new_PRFGCOD FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PRFGCOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFUFECALT',TO_CHAR(AUD_old_PRFUFECALT,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFUFECALT,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PRFUFECALT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFUFECVTO',TO_CHAR(AUD_old_PRFUFECVTO,'YYYY-MM-DD'),TO_CHAR(AUD_new_PRFUFECVTO,'YYYY-MM-DD') FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PRFUFECVTO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFUTPO',AUD_old_PRFUTPO,AUD_new_PRFUTPO FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PRFUTPO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'PRFUUSER',AUD_old_PRFUUSER,AUD_new_PRFUUSER FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'PRFUUSER'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PRFU00_UOn,AUD_PRFU00_GuidKey,'UBUSER',AUD_old_UBUSER,AUD_new_UBUSER FROM BANTPROD.AUD_PRFU00_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey AND AUDMstFld = 'UBUSER'); DELETE FROM AUD_PRFU00_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PRFU00_UOn AND AUDMstId = AUD_PRFU00_GuidKey);  COMMIT ;END IF;END;
/

