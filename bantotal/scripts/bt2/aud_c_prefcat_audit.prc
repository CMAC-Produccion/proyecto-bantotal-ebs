CREATE OR REPLACE PROCEDURE AUD_C_PREFCAT_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_PREFCAT_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PREFCAT',CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( '|PRFCAT=', RTRIM(COALESCE(AUD_old_PRFCAT,AUD_new_PRFCAT)) ),CONCAT( '|PRFEMP=', RTRIM(COALESCE(AUD_old_PRFEMP,AUD_new_PRFEMP)) ) ),CONCAT( '|PRFMOD=', RTRIM(COALESCE(AUD_old_PRFMOD,AUD_new_PRFMOD)) ) ),CONCAT( '|PRFTRN=', RTRIM(COALESCE(AUD_old_PRFTRN,AUD_new_PRFTRN)) ) ),'|' ),AUD_PREFCAT_UBT,AUD_PREFCAT_UBU,AUD_PREFCAT_UBM,AUD_PREFCAT_UBP,AUD_PREFCAT_UBR,AUD_PREFCAT_UAs,AUD_PREFCAT_UBC,AUD_PREFCAT_UBA,AUD_PREFCAT_UBS, '', 'BANTOTAL', '', '', '',AUD_PREFCAT_UT FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFCAT',AUD_old_PRFCAT,AUD_new_PRFCAT FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFCAT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFCATHAB',AUD_old_PRFCATHAB,AUD_new_PRFCATHAB FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFCATHAB'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFCATORD',AUD_old_PRFCATORD,AUD_new_PRFCATORD FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFCATORD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFCATTIT',AUD_old_PRFCATTIT,AUD_new_PRFCATTIT FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFCATTIT'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFEMP',AUD_old_PRFEMP,AUD_new_PRFEMP FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFEMP'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFMOD',AUD_old_PRFMOD,AUD_new_PRFMOD FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFMOD'); INSERT INTO BANTPROD.AUD005 SELECT AUD_PREFCAT_UOn,AUD_PREFCAT_GuidKey,'PRFTRN',AUD_old_PRFTRN,AUD_new_PRFTRN FROM BANTPROD.AUD_PREFCAT_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey AND AUDMstFld = 'PRFTRN'); DELETE FROM AUD_PREFCAT_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_PREFCAT_UOn AND AUDMstId = AUD_PREFCAT_GuidKey);  COMMIT ;END IF;END;
/

