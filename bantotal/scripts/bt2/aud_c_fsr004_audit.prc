CREATE OR REPLACE PROCEDURE AUD_C_FSR004_AUDIT AS cnt NUMBER; BEGIN SELECT COUNT(*) INTO cnt FROM BANTPROD.AUD_FSR004_AUDIT; IF( cnt > 0 ) THEN INSERT INTO BANTPROD.AUD004 (AUDMstTim, AUDMstId, AUDMstTbl, AUDMstKey, AUDMstTrn, AUDMstUsr, AUDMstWst, AUDMstPgm, AUDMstReq, AUDMstTyp, AUDMstCon, AUDMstApp, AUDMstSrv, AUDMstSes, AUDMstGrp, AUDMstLog, AUDMstCur, AUDMstSnt,AUDMstTic) SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'FSR004',CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( CONCAT( '|IFCMDA=', RTRIM(COALESCE(AUD_old_IFCMDA,AUD_new_IFCMDA)) ),CONCAT( '|IFCNRO=', RTRIM(COALESCE(AUD_old_IFCNRO,AUD_new_IFCNRO)) ) ),CONCAT( '|IFNDOC=', RTRIM(COALESCE(AUD_old_IFNDOC,AUD_new_IFNDOC)) ) ),CONCAT( '|IFPAIS=', RTRIM(COALESCE(AUD_old_IFPAIS,AUD_new_IFPAIS)) ) ),CONCAT( '|IFTDOC=', RTRIM(COALESCE(AUD_old_IFTDOC,AUD_new_IFTDOC)) ) ),'|' ),AUD_FSR004_UBT,AUD_FSR004_UBU,AUD_FSR004_UBM,AUD_FSR004_UBP,AUD_FSR004_UBR,AUD_FSR004_UAs,AUD_FSR004_UBC,AUD_FSR004_UBA,AUD_FSR004_UBS, '', 'BANTOTAL', '', '', '',AUD_FSR004_UT FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'IFCMDA',AUD_old_IFCMDA,AUD_new_IFCMDA FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey AND AUDMstFld = 'IFCMDA'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'IFCNRO',AUD_old_IFCNRO,AUD_new_IFCNRO FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey AND AUDMstFld = 'IFCNRO'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'IFNDOC',AUD_old_IFNDOC,AUD_new_IFNDOC FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey AND AUDMstFld = 'IFNDOC'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'IFPAIS',AUD_old_IFPAIS,AUD_new_IFPAIS FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey AND AUDMstFld = 'IFPAIS'); INSERT INTO BANTPROD.AUD005 SELECT AUD_FSR004_UOn,AUD_FSR004_GuidKey,'IFTDOC',AUD_old_IFTDOC,AUD_new_IFTDOC FROM BANTPROD.AUD_FSR004_AUDIT WHERE NOT EXISTS (SELECT * FROM BANTPROD.AUD005 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey AND AUDMstFld = 'IFTDOC'); DELETE FROM AUD_FSR004_AUDIT  WHERE  EXISTS (SELECT * FROM BANTPROD.AUD004 WHERE AUDMstTim = AUD_FSR004_UOn AND AUDMstId = AUD_FSR004_GuidKey);  COMMIT ;END IF;END;
/

