CREATE OR REPLACE PROCEDURE DEPURATE_AUDIT AS LastDepurateTime DATE; BEGIN  SELECT AUDGrpDTE INTO LastDepurateTime FROM BANTPROD.AUD001 WHERE AUDGrpNam = 'BANTOTAL'; DELETE FROM BANTPROD.AUD004 A WHERE A.AUDMstTim >= LastDepurateTime AND A.AUDMstTyp = 'U' AND NOT EXISTS (SELECT * FROM BANTPROD.AUD005 B WHERE B.AUDMstTim >= LastDepurateTime AND A.AUDMstTim = B.AUDMstTim AND A.AUDMstId  = B.AUDMstId AND B.AUDMstOld <> B.AUDMstNew); DELETE FROM BANTPROD.AUD005 B WHERE B.AUDMstTim >= LastDepurateTime AND NOT EXISTS (SELECT * FROM BANTPROD.AUD004 A WHERE A.AUDMstTim = B.AUDMstTim AND A.AUDMstId  = B.AUDMstId AND A.AUDMstTim >= LastDepurateTime ); UPDATE BANTPROD.AUD001 SET AUDGrpDTE = SYSDATE WHERE AUDGrpNam = 'BANTOTAL'; COMMIT; END;
/

